<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Serialization and Separating Declaration and Definition in Header Only Libraries" /><meta property="og:locale" content="en" /><meta name="description" content="In my personal projects, and at work, I have been venturing very heavily into templated libraries. Sometimes the project was completely header-only, other times it was a hybrid. In my most recent endeavor, I was challenged with creating a templated library that was “closed” off from additional implementations. These challenges pressured me into understanding the purpose of certain design patterns and how larger projects, like Boost, utilized them to build incredible libraries. In this post, I am going to walkthrough three design-ideas to approaching header-only libraries and discuss their pros and cons." /><meta property="og:description" content="In my personal projects, and at work, I have been venturing very heavily into templated libraries. Sometimes the project was completely header-only, other times it was a hybrid. In my most recent endeavor, I was challenged with creating a templated library that was “closed” off from additional implementations. These challenges pressured me into understanding the purpose of certain design patterns and how larger projects, like Boost, utilized them to build incredible libraries. In this post, I am going to walkthrough three design-ideas to approaching header-only libraries and discuss their pros and cons." /><link rel="canonical" href="https://khurd21.github.io/posts/cpp-template-project-structure/" /><meta property="og:url" content="https://khurd21.github.io/posts/cpp-template-project-structure/" /><meta property="og:site_name" content="Kyle Hurd" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-09-06T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Serialization and Separating Declaration and Definition in Header Only Libraries" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-09-06T17:00:00+00:00","datePublished":"2023-09-06T00:00:00+00:00","description":"In my personal projects, and at work, I have been venturing very heavily into templated libraries. Sometimes the project was completely header-only, other times it was a hybrid. In my most recent endeavor, I was challenged with creating a templated library that was “closed” off from additional implementations. These challenges pressured me into understanding the purpose of certain design patterns and how larger projects, like Boost, utilized them to build incredible libraries. In this post, I am going to walkthrough three design-ideas to approaching header-only libraries and discuss their pros and cons.","headline":"Serialization and Separating Declaration and Definition in Header Only Libraries","mainEntityOfPage":{"@type":"WebPage","@id":"https://khurd21.github.io/posts/cpp-template-project-structure/"},"url":"https://khurd21.github.io/posts/cpp-template-project-structure/"}</script><title>Serialization and Separating Declaration and Definition in Header Only Libraries | Kyle Hurd</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Kyle Hurd"><meta name="application-name" content="Kyle Hurd"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/kyle-hurd-close-up.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Kyle Hurd</a></div><div class="site-subtitle font-italic">Programmer | WSU | Fall 2022</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/resume/" class="nav-link"> <i class="fa-fw fas fa-book ml-xl-3 mr-xl-3 unloaded"></i> <span>RESUME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/khurd21" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/kyle-hurd-ab8168252/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['kyle.hurd','wsu.edu'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://soundcloud.com/kyle-hurd-3" aria-label="soundcloud" target="_blank" rel="noopener"> <i class="fas fa-music"></i> </a> <a href="" aria-label="" target="_blank" rel="noopener"> <i class=""></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Serialization and Separating Declaration and Definition in Header Only Libraries</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Serialization and Separating Declaration and Definition in Header Only Libraries</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1693958400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 6, 2023 </em> </span> <span> Updated <em class="" data-ts="1694019600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 6, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/khurd21">Kyle Hurd</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1312 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p>In my personal projects, and at work, I have been venturing very heavily into templated libraries. Sometimes the project was completely header-only, other times it was a hybrid. In my most recent endeavor, I was challenged with creating a templated library that was “closed” off from additional implementations. These challenges pressured me into understanding the purpose of certain design patterns and how larger projects, like Boost, utilized them to build incredible libraries. In this post, I am going to walkthrough three design-ideas to approaching header-only libraries and discuss their pros and cons.</p><h2 id="1-header-only-literally"><span class="mr-2">1. Header Only (Literally)</span><a href="#1-header-only-literally" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The first C++ structured project I learned was separation of declaration and definition. That is, use the <code class="language-plaintext highlighter-rouge">.hpp</code> files to store declarations only. A statement saying “I promise this definition will be available, eventually, when compiling.” In the following example, I am going to walk through a design decision for serializing and deserializing JSON into a C++ object. When first addressing this problem, I decided to write code similar to the following:</p><h3 id="iparsablehpp"><span class="mr-2">IParsable.hpp</span><a href="#iparsablehpp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="cp">#ifndef I_PARSABLE_HPP
#define I_PARSABLE_HPP
</span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">IParsable</span> <span class="p">{</span>

  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">};</span> <span class="c1">// class IParsable</span>

<span class="cp">#endif // I_PARSABLE_HPP
</span></pre></table></code></div></div><h3 id="userhpp"><span class="mr-2">User.hpp</span><a href="#userhpp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="cp">#ifndef USER_HPP
#define USER_HPP
</span>
<span class="cp">#include</span> <span class="cpf">&lt;IParsable.hpp&gt;</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">:</span> <span class="k">public</span> <span class="n">IParsable</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">UserId</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">FirstName</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">LastName</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">Age</span><span class="p">;</span>

  <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span> <span class="k">const</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// TODO: Add serialize() functionality here</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// TODO: Add deserialize() functionality here</span>
  <span class="p">}</span>

<span class="p">};</span> <span class="c1">// class User</span>

<span class="cp">#endif // USER_HPP
</span></pre></table></code></div></div><p>This implementation works and is a viable solution and takes on a very object oriented approach. It is simple and modular. There is a way we handle it though that I find not ideal. We have to create an instance of the object before we can use the serialize and deserialize methods. This means we have to make an empty object initially and then load in data into it. Additionally, the functionality of serialize and deserialize never change between objects, or are not instance specific.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">input</span> <span class="o">=</span> <span class="n">read_json_from_file</span><span class="p">(</span><span class="s">"User.json"</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">user</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">user</span><span class="o">-&gt;</span><span class="n">deserialize</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"UserID: "</span> <span class="o">&lt;&lt;</span> <span class="n">user</span><span class="o">-&gt;</span><span class="n">UserId</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">Age: "</span> <span class="o">&lt;&lt;</span> <span class="n">user</span><span class="o">-&gt;</span><span class="n">Age</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>

<span class="n">std</span><span class="o">::</span><span class="n">istream</span> <span class="n">is</span><span class="p">;</span>
<span class="n">user</span><span class="o">-&gt;</span><span class="n">serialize</span><span class="p">(</span><span class="n">is</span><span class="p">);</span>
</pre></table></code></div></div><p>One solution to keep this approach is to simply create a wrapper around the serialization and deserialization methods.</p><h3 id="parsablefactoryhpp"><span class="mr-2">ParsableFactory.hpp</span><a href="#parsablefactoryhpp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Parsable</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">ParsableFactory</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="k">static_assert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_base_of</span><span class="o">&lt;</span><span class="n">IParsable</span><span class="p">,</span> <span class="n">Parsable</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="s">"Parsable must be derived from IParsable"</span><span class="p">);</span>

  <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Parsable</span><span class="o">&gt;</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Parsable</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Parsable</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="n">result</span><span class="o">-&gt;</span><span class="n">deserialize</span><span class="p">(</span><span class="n">is</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">static</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="k">const</span> <span class="n">Parsable</span><span class="o">&amp;</span> <span class="n">parsable</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">parsable</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">};</span> <span class="c1">// class ParsableFactory</span>
</pre></table></code></div></div><p>It is a great way to help scale the program for if there are many classes that inherit and implement the <code class="language-plaintext highlighter-rouge">IParsable</code> interface. All interactions can come directly from the <code class="language-plaintext highlighter-rouge">ParsableFactory</code>, and if there is a requirement to enforce this behavior, it is possible to protect the serialize and deserialize functions in the class and create a <code class="language-plaintext highlighter-rouge">friend</code> relationship to the factory.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">std</span><span class="o">::</span><span class="n">istream</span> <span class="nf">is</span><span class="p">(</span><span class="cm">/* serializable string*/</span><span class="p">);</span>
<span class="k">const</span> <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">ParsableFactory</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;::</span><span class="n">deserialize</span><span class="p">(</span><span class="n">is</span><span class="p">);</span> <span class="c1">// OK</span>

<span class="cm">/* ... */</span>

<span class="n">User</span> <span class="n">user</span><span class="p">;</span>
<span class="n">user</span><span class="p">.</span><span class="n">serialize</span><span class="p">();</span> <span class="c1">// Error: protected member</span>
</pre></table></code></div></div><p>There is one particular aspect I do not like about this implementation. The primary one is that the serialize and deserialize are not reliant on a particular instance to be used. And in my head, we should be using deserialize as a means to generate a new <code class="language-plaintext highlighter-rouge">IParsable</code> object, not to fill an already existing object. Due to this, there is another way we can enforce having this functionality while also keeping the function members static.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Object</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">IParsable</span> <span class="p">{</span>

  <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">serialize</span><span class="p">(</span><span class="k">const</span> <span class="n">Object</span><span class="o">&amp;</span> <span class="n">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Object</span><span class="o">::</span><span class="n">serialize_internal</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">static</span> <span class="n">Object</span> <span class="n">deserialize</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Object</span><span class="o">::</span><span class="n">deserialize_internal</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span> <span class="c1">// class IParsable</span>
</pre></table></code></div></div><p>The new <code class="language-plaintext highlighter-rouge">IParsable</code> is acting like the <code class="language-plaintext highlighter-rouge">ParsableFactory</code> while also enforcing that a static implementation of <code class="language-plaintext highlighter-rouge">deserialize_internal</code> and <code class="language-plaintext highlighter-rouge">serialize_internal</code> be implemented in the inheriting class. The new <code class="language-plaintext highlighter-rouge">User</code> class would then look like:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">:</span> <span class="k">public</span> <span class="n">IParsable</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">UserId</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">FirstName</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">LastName</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">Age</span><span class="p">;</span>

<span class="nl">protected:</span>
  <span class="k">friend</span> <span class="n">IParsable</span><span class="p">;</span>

  <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">serialize_internal</span><span class="p">(</span><span class="k">const</span> <span class="n">User</span><span class="o">&amp;</span> <span class="n">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Add serialize here</span>
    <span class="k">return</span> <span class="p">{};</span>
  <span class="p">}</span>

  <span class="k">static</span> <span class="n">User</span> <span class="n">deserialize_internal</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Add deserialize here</span>
    <span class="k">return</span> <span class="p">{};</span>
  <span class="p">}</span>

<span class="p">};</span> <span class="c1">// class User</span>
</pre></table></code></div></div><p>Although it is almost identical, I prefer this one a lot more. The way you utilize any of the serialize or deserialize functions is a bit different, not requiring the user to understand which classes support the <code class="language-plaintext highlighter-rouge">IParsable</code> interface, which they would typically find out during compile time from the assert statements. This way, we can get function suggestions straight from the class we want to parse:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">input</span> <span class="o">=</span> <span class="cm">/* read in content */</span><span class="p">;</span>
<span class="k">const</span> <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">::</span><span class="n">deserialize</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
</pre></table></code></div></div><p>For the rest of this post, I am going to be using the static member function approach. Throughout this, I was writing assuming everything was being placed in the header files. Which leads me to a second and my preferred way to writing quality C++ code with template and non-template functions.</p><h2 id="2-separate-declaration-and-definition"><span class="mr-2">2. Separate Declaration and Definition</span><a href="#2-separate-declaration-and-definition" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>When it comes to templated classes and functions, we really do not have a choice but to put them in the header. But that doesn’t mean the definition has to be baked in with the header declarations. Taking a look at the <a href="https://github.com/boostorg/boost">Boost Library</a>, they separate their implementation by placing the definitions in an <code class="language-plaintext highlighter-rouge">.ipp</code> file usually in a <code class="language-plaintext highlighter-rouge">impl</code> folder. The i stands for inline, as all definitions in it need to be inlined. We can utilize this approach to separate the implementation in the <code class="language-plaintext highlighter-rouge">IParsable</code> file:</p><h3 id="iparsablehpp-1"><span class="mr-2">IParsable.hpp</span><a href="#iparsablehpp-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="cp">#ifndef IPARSABLE_HPP
#define IPARSABLE_HPP
</span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Object</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">IParsable</span> <span class="p">{</span>

  <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">serialize</span><span class="p">(</span><span class="k">const</span> <span class="n">Object</span><span class="o">&amp;</span> <span class="n">object</span><span class="p">);</span>

  <span class="k">static</span> <span class="n">Object</span> <span class="n">deserialize</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">input</span><span class="p">);</span>
<span class="p">};</span> <span class="c1">// class IParsable</span>

<span class="cp">#include</span> <span class="cpf">&lt;ProjectName/impl/IParsable.ipp&gt;</span><span class="cp">
</span>
<span class="cp">#endif // IPARSABLE_HPP
</span></pre></table></code></div></div><h3 id="impliparsableipp"><span class="mr-2">impl/IParsable.ipp</span><a href="#impliparsableipp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="cp">#ifndef IPARSABLE_IPP
#define IPARSABLE_IPP
</span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;ProjectName/IParsable.hpp&gt;</span><span class="cp">
</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Object</span><span class="p">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">IParsable</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="k">const</span> <span class="n">Object</span><span class="o">&amp;</span> <span class="n">object</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{};</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Object</span><span class="p">&gt;</span>
<span class="n">Object</span> <span class="n">IParsable</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">deserialize</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{};</span>
<span class="p">}</span>

<span class="cp">#endif // IPARSABLE_IPP
</span></pre></table></code></div></div><p>The goal is to create a <code class="language-plaintext highlighter-rouge">impl</code> folder and place the <code class="language-plaintext highlighter-rouge">IParsable.ipp</code> inside of it. Then, at the very bottom of the header file, include <code class="language-plaintext highlighter-rouge">IParsable.ipp</code>. As long as they are templated or inlined, then this separation will work just fine. I tend to only use the <code class="language-plaintext highlighter-rouge">.ipp</code> if there are templated functions being used. Anything that doesn’t have to be used in the header can go into the <code class="language-plaintext highlighter-rouge">.cpp</code> files as usual.</p><h2 id="3-closing-off-the-templated-functions"><span class="mr-2">3. “Closing” off the templated functions</span><a href="#3-closing-off-the-templated-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>One concern that many people have with templated functions is that we leave any user open to pass anything and implement anything for the template. There are ways to help avoid this if this is not wanted. One method that I found was to instead of include the <code class="language-plaintext highlighter-rouge">.ipp</code> file at the bottom of the header, to include it in the <code class="language-plaintext highlighter-rouge">.cpp</code> file and then specialize the template for each type you want supported.</p><h3 id="iparsablecpp"><span class="mr-2">IParsable.cpp</span><a href="#iparsablecpp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;ProjectName/impl/IParsable.ipp&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;ProjectName/User.hpp&gt;</span><span class="cp">
</span>
<span class="n">IParsable</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">;</span>
</pre></table></code></div></div><p>Now there are only specializations for the <code class="language-plaintext highlighter-rouge">User</code> class. If you want to add more for other classes, simply add the specialization in the <code class="language-plaintext highlighter-rouge">.cpp</code> file.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/programming/'>programming</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/cpp/" class="post-tag no-text-decoration" >cpp</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Serialization+and+Separating+Declaration+and+Definition+in+Header+Only+Libraries+-+Kyle+Hurd&url=https%3A%2F%2Fkhurd21.github.io%2Fposts%2Fcpp-template-project-structure%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Serialization+and+Separating+Declaration+and+Definition+in+Header+Only+Libraries+-+Kyle+Hurd&u=https%3A%2F%2Fkhurd21.github.io%2Fposts%2Fcpp-template-project-structure%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fkhurd21.github.io%2Fposts%2Fcpp-template-project-structure%2F&text=Serialization+and+Separating+Declaration+and+Definition+in+Header+Only+Libraries+-+Kyle+Hurd" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/cpp-template-project-structure/">Serialization and Separating Declaration and Definition in Header Only Libraries</a><li><a href="/posts/cpp-threads/">Threading in C++</a><li><a href="/posts/cpp-parallel-prefix-sum/">Parallel Implementation of Prefix Sum</a><li><a href="/posts/cpp-cmake-openmp/">Adding Boost and OpenMP Library to CMake Project</a><li><a href="/posts/cpp-exploring-for-loops/">Exploring For Loops in Cpp</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cpp/">cpp</a> <a class="post-tag" href="/tags/boost/">boost</a> <a class="post-tag" href="/tags/openmp/">openmp</a> <a class="post-tag" href="/tags/parameterized-tests/">parameterized-tests</a> <a class="post-tag" href="/tags/testing/">testing</a> <a class="post-tag" href="/tags/animals/">animals</a> <a class="post-tag" href="/tags/c/">c#</a> <a class="post-tag" href="/tags/cmake/">cmake</a> <a class="post-tag" href="/tags/first-post/">first-post</a> <a class="post-tag" href="/tags/python/">python</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/cpp-exploring-for-loops/"><div class="card-body"> <em class="small" data-ts="1674000000" data-df="ll" > Jan 18, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Exploring For Loops in Cpp</h3><div class="text-muted small"><p> This week I was diving into some of the new features C++ has regarding iteration. This newfound interest stemmed from wanting to make cleaner, more understandable code. There have been many situati...</p></div></div></a></div><div class="card"> <a href="/posts/cpp-cmake-openmp/"><div class="card-body"> <em class="small" data-ts="1675900800" data-df="ll" > Feb 9, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Adding Boost and OpenMP Library to CMake Project</h3><div class="text-muted small"><p> Starting around mid-2021, I discovered a website called Project Euler. Project Euler “is a series of challenging mathematical/computer programming problems that will require more than just mathemat...</p></div></div></a></div><div class="card"> <a href="/posts/cpp-parallel-prefix-sum/"><div class="card-body"> <em class="small" data-ts="1677715200" data-df="ll" > Mar 2, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Parallel Implementation of Prefix Sum</h3><div class="text-muted small"><p> For a while, I have been invested in learning how to parallelize certain algorithms. Parallelizing algorithms and code in general can be tricky. I have discovered that it is quite tricky. It is sur...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/cpp-threads/" class="btn btn-outline-primary" prompt="Older"><p>Threading in C++</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div><div class="footer-right"> <br><p class="mb-0"></p></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cpp/">cpp</a> <a class="post-tag" href="/tags/boost/">boost</a> <a class="post-tag" href="/tags/openmp/">openmp</a> <a class="post-tag" href="/tags/parameterized-tests/">parameterized-tests</a> <a class="post-tag" href="/tags/testing/">testing</a> <a class="post-tag" href="/tags/animals/">animals</a> <a class="post-tag" href="/tags/c/">c#</a> <a class="post-tag" href="/tags/cmake/">cmake</a> <a class="post-tag" href="/tags/first-post/">first-post</a> <a class="post-tag" href="/tags/python/">python</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
